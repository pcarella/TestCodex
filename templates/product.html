{% extends 'base.html' %}
{% block content %}
<style>
  .product-hero {
    background: #ffffff;
    border: 1px solid rgba(45, 42, 50, 0.06);
    box-shadow: 0 24px 64px rgba(0, 0, 0, 0.06);
    border-radius: 18px;
    padding: 1.5rem 1.75rem;
  }

  .form-section {
    border: 1px solid rgba(45, 42, 50, 0.06);
    border-radius: 16px;
    padding: 1.5rem;
    background: #ffffff;
  }

  .form-section + .form-section {
    margin-top: 1rem;
  }

  .form-label {
    font-weight: 600;
    color: #1f2937;
  }

  .form-control-lg,
  .form-select-lg,
  .input-group-lg > .form-control,
  .input-group-lg > .input-group-text {
    border-radius: 12px;
    padding: 0.9rem 1rem;
  }

  textarea.form-control {
    min-height: 140px;
  }

  .preview-card {
    position: sticky;
    top: 88px;
  }

  .preview-image {
    width: 100%;
    max-height: 320px;
    object-fit: contain;
    background: #f9fafb;
    border-radius: 12px;
    padding: 1rem;
    border: 1px dashed #e5e7eb;
  }

  .detail-badge {
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 0.75rem 1rem;
  }
</style>

<div class="row justify-content-center mb-4">
  <div class="col-xl-10">
    <div class="product-hero d-flex align-items-start justify-content-between flex-wrap gap-3">
      <div>
        <p class="text-uppercase text-muted fw-semibold mb-1 small">Scheda prodotto</p>
        <h1 class="h3 mb-1">Codice {{ product.code }}</h1>
        <p class="mb-0 text-secondary">Aggiorna le informazioni prima di confermare l'invio al PIM.</p>
        <nav aria-label="Percorso" class="small mt-2">
          <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a href="{{ url_for('results') }}">Risultati</a></li>
            <li class="breadcrumb-item active" aria-current="page">Codice {{ product.code }}</li>
          </ol>
        </nav>
      </div>
      <div class="d-flex align-items-center gap-3">
        <div class="badge rounded-pill text-bg-warning text-dark px-3 py-2 shadow-sm">Step 3/3 · In revisione</div>
        <a class="btn btn-outline-secondary" href="{{ url_for('results') }}">Torna ai risultati</a>
      </div>
    </div>
  </div>
</div>

<div class="row justify-content-center g-4">
  <div class="col-xl-7 col-xxl-8">
    <div class="alert alert-info border-0 shadow-sm" role="alert">
      Alcuni campi sono stati suggeriti dall'AI. Puoi modificarli prima di salvare.
    </div>
    <form method="post" class="row g-4">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
      <div class="form-section col-12">
        <div class="d-flex align-items-center gap-2 mb-3">
          <div class="rounded-circle bg-warning-subtle text-warning-emphasis d-inline-flex align-items-center justify-content-center fw-bold circle-36">1</div>
          <div>
            <p class="text-uppercase text-muted fw-semibold mb-0 small">Informazioni di base</p>
            <h2 class="h5 mb-0">Completa i campi del PIM</h2>
          </div>
        </div>
        <div class="row g-4">
          <div class="col-md-6">
            <label class="form-label" for="code">Codice prodotto</label>
            <input type="text" class="form-control form-control-lg" id="code" value="{{ product.code }}" readonly />
          </div>
          <div class="col-md-6">
            <label class="form-label" for="codice_ean">EAN / UPC</label>
            <input type="text" class="form-control form-control-lg" id="codice_ean" value="{{ product.codice_ean or '—' }}" readonly />
          </div>
          <div class="col-12">
            <label class="form-label" for="denominazione_vendita">Nome prodotto</label>
            <input type="text" class="form-control form-control-lg" id="denominazione_vendita" name="denominazione_vendita" value="{{ product.denominazione_vendita }}" required />
          </div>
          <div class="col-md-6">
            <label class="form-label" for="marchio">Marchio</label>
            <input type="text" class="form-control form-control-lg" id="marchio" value="{{ product.marchio or '—' }}" readonly />
          </div>
          <div class="col-md-6">
            <label class="form-label" for="nome_marca">Nome marca</label>
            <input type="text" class="form-control form-control-lg" id="nome_marca" value="{{ product.nome_marca or '—' }}" readonly />
          </div>
          <div class="col-md-6">
            <label class="form-label" for="stato_pubblicazione">Stato pubblicazione</label>
            <select id="stato_pubblicazione" class="form-select form-select-lg" disabled>
              <option selected>Bozza</option>
            </select>
          </div>
        </div>
      </div>

      <div class="form-section col-12">
        <div class="d-flex align-items-center gap-2 mb-3">
          <div class="rounded-circle bg-warning-subtle text-warning-emphasis d-inline-flex align-items-center justify-content-center fw-bold circle-36">2</div>
          <div>
            <p class="text-uppercase text-muted fw-semibold mb-0 small">Appartenenza</p>
            <h2 class="h5 mb-0">Categorizza il prodotto</h2>
          </div>
        </div>
        <div class="row g-4">
          <div class="col-md-6">
            <label class="form-label" for="categoria_suggested">Categoria attuale (PIM)</label>
            <select id="categoria_suggested" class="form-select form-select-lg" disabled>
              {% if product.categories %}
              <option selected>{{ product.categories[0].name }}</option>
              {% else %}
              <option selected>Nessuna categoria presente</option>
              {% endif %}
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label d-flex align-items-center gap-2" for="categoria_ai">
              Categoria suggerita da AI
              {% if product.ai_category %}
              {% set ai = product.ai_category %}
              <span class="badge text-bg-warning text-dark">{{ ai.category_2_name or ai.category_1_name }}</span>
              <span class="badge text-bg-light border">{{ ai.category_2_id }}</span>
              {% endif %}
            </label>
            <select id="categoria_ai" class="form-select form-select-lg">
              {% if product.categories %}
              {% for category in product.categories %}
              <option {% if loop.first %}selected{% endif %}>{{ category.name }}</option>
              {% endfor %}
              {% else %}
              <option selected>Seleziona una categoria</option>
              {% endif %}
            </select>
            <small class="text-muted d-block mt-1">Seleziona l'opzione di PIM più appropriata</small>
            {% if product.ai_category %}
            <p class="text-muted small mb-0 mt-1">Motivazione AI: {{ product.ai_category.reason }}</p>
            {% endif %}
          </div>
          <div class="col-md-6">
            <label class="form-label" for="price">Prezzo al kg</label>
            <div class="input-group input-group-lg">
              <span class="input-group-text">€</span>
              <input type="number" step="0.01" class="form-control" id="price" name="price" value="{{ '%.2f'|format(product.price) }}" required />
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label" for="brand_value">Valore di riferimento</label>
            <input type="text" class="form-control form-control-lg" id="brand_value" value="{{ product.denominazione_vendita or '—' }}" readonly />
          </div>
          <div class="col-12">
            <label class="form-label" for="descrizione_marketing">Contenuti descrittivi</label>
            <textarea class="form-control form-control-lg" id="descrizione_marketing" name="descrizione_marketing" rows="5" required placeholder="Inserisci la descrizione marketing">{{ product.descrizione_marketing }}</textarea>
            <small class="text-muted d-block mt-1">Massimo 250 caratteri. Test brevi, formali e chiari, ideali per i primi passi di tutti i giorni, caldi come una giacca invernale.</small>
          </div>
          <div class="col-12">
            <label class="form-label" for="description">Descrizione PIM</label>
            <textarea class="form-control form-control-lg" id="description" rows="4" readonly placeholder="Descrizione non disponibile">{{ product.description }}</textarea>
          </div>
        </div>
      </div>

      <div class="col-12 d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-2 text-secondary">
          <div class="rounded-circle bg-warning-subtle text-warning-emphasis d-inline-flex align-items-center justify-content-center fw-bold circle-34">✓</div>
          <div>
            <div class="fw-semibold">Conferma necessaria</div>
            <small class="text-muted">Controlla i campi prima di inviare al PIM.</small>
          </div>
        </div>
        <div class="d-flex gap-3">
          <a class="btn btn-outline-secondary" href="{{ url_for('results') }}">Annulla</a>
          <button type="submit" class="btn btn-primary px-4" id="submit-product">
            <span class="spinner-border spinner-border-sm align-text-bottom me-2 d-none" role="status" aria-hidden="true"></span>
            <span class="submit-label">Invia al PIM</span>
          </button>
        </div>
      </div>
    </form>
  </div>

  <div class="col-xl-4 col-xxl-3">
    <div class="card border-0 shadow-sm preview-card">
      <div class="card-body d-flex flex-column gap-3">
        <div class="d-flex align-items-start justify-content-between">
          <div>
            <p class="text-uppercase text-muted fw-semibold mb-1 small">Anteprima prodotto</p>
            <h2 class="h5 mb-0">{{ product.denominazione_vendita or 'Denominazione non disponibile' }}</h2>
            <p class="text-secondary mb-0">Cod. {{ product.code }}</p>
          </div>
          <div class="badge bg-white text-warning-emphasis border border-warning">EAN: {{ product.codice_ean or '—' }}</div>
        </div>
        <img
          src="https://spesaonline.conad.it/assets/products/{{ product.code }}/ID-Shot.jpeg"
          alt="Anteprima prodotto"
          class="preview-image"
          onerror="this.src='https://via.placeholder.com/400x400?text=Immagine+non+disponibile';"
        />
        <div class="detail-badge">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="text-muted small">Categoria</span>
            {% if product.categories %}
            <span class="badge text-bg-light border">{{ product.categories[0].name }}</span>
            {% else %}
            <span class="badge text-bg-light border">—</span>
            {% endif %}
          </div>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="text-muted small">Prezzo</span>
            <div class="fw-semibold fs-5 text-success">€ {{ '%.2f'|format(product.price) }}</div>
          </div>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="text-muted small">Marchio</span>
            <span class="badge text-bg-light border">{{ product.marchio or '—' }}</span>
          </div>
          <div class="text-muted small">Descrizione marketing</div>
          <p class="mb-0 fw-medium">{{ product.descrizione_marketing }}</p>
          <div class="text-muted small mt-3">Descrizione PIM</div>
          <p class="mb-0">{{ product.description or '—' }}</p>
        </div>
        <div>
          <p class="text-muted text-uppercase small fw-semibold mb-2">Codici categoria disponibili</p>
          <ul class="mb-0 small text-muted ps-3">
            {% for category in product.categories %}
            <li><strong>{{ category.code }}</strong> — {{ category.name }}</li>
            {% else %}
            <li>Nessuna categoria presente nella risposta.</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  (function () {
    const form = document.querySelector("form");
    const submitButton = document.getElementById("submit-product");
    const spinner = submitButton?.querySelector(".spinner-border");
    const label = submitButton?.querySelector(".submit-label");
    form?.addEventListener("submit", () => {
      submitButton.setAttribute("disabled", "disabled");
      spinner?.classList.remove("d-none");
      label.textContent = "Salvataggio in corso...";
    });
  })();
</script>
{% endblock %}
