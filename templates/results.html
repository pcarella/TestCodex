{% extends 'base.html' %}
{% block content %}
{% set total = products | length %}
{% set ready_count = status_counts.get('ready', 0) %}
{% set review_count = status_counts.get('review', 0) %}
{% set error_count = status_counts.get('error', 0) %}

<div class="d-flex flex-wrap gap-3 justify-content-between align-items-start mb-3">
  <div>
    <div class="section-title mb-2"><span class="text-warning">●</span> Riepilogo</div>
    <h1 class="h4 mb-1">Prodotti richiesti</h1>
    <p class="text-muted mb-0">I dati mostrati provengono dall'API OCC. Tutti i prodotti recuperati partono in stato "Richiede revisione".</p>
  </div>
  <div class="text-end">
    <div class="summary-chip mb-2">
      <span class="fw-bold">{{ total }}</span>
      <span class="text-muted">prodotti trovati</span>
    </div>
    <div class="small text-muted">{{ ready_count }} pronti, {{ review_count }} da rivedere, {{ error_count }} in errore.</div>
  </div>
</div>

  <div class="alert alert-info shadow-soft" role="status" aria-live="polite">
    <div class="fw-semibold">Significato degli stati</div>
    <ul class="legend-list small mb-0">
      <li><span class="status-pill status-ready"><span class="status-dot"></span>Pronto</span> Contenuti completi e pronti per il PIM.</li>
      <li><span class="status-pill status-review"><span class="status-dot"></span>Richiede revisione</span> Controlla titolo o categoria prima di inviare.</li>
      <li><span class="status-pill status-error"><span class="status-dot"></span>Errore</span> Codice non riconosciuto o dati mancanti.</li>
    </ul>
  </div>

  {% if missing_codes %}
  <div class="alert alert-warning" role="alert">
    <div class="fw-semibold">Codici non trovati (API in errore):</div>
    <p class="mb-0">{{ missing_codes | join(', ') }}</p>
  </div>
  {% endif %}

<div class="card brand-card mb-3">
  <div class="card-body">
    <form class="row gy-3 align-items-end" method="get">
      <div class="col-lg-5">
        <label class="form-label" for="q">Cerca</label>
        <input type="text" class="form-control" id="q" name="q" placeholder="Cerca per codice o nome prod" value="{{ request.args.get('q', '') }}" />
      </div>
      <div class="col-lg-3 col-md-6">
        <label class="form-label" for="status">Stato</label>
        <select class="form-select" id="status" name="status">
          <option value="">Tutti gli stati</option>
          {% for key, meta in status_choices.items() %}
          <option value="{{ key }}" {% if status_filter == key %}selected{% endif %}>{{ meta.label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-lg-3 col-md-6">
        <label class="form-label" for="category">Categoria</label>
        <select class="form-select" id="category" name="category">
          <option value="">Tutte le categorie</option>
          {% for category in categories %}
          <option value="{{ category }}" {% if category_filter == category %}selected{% endif %}>{{ category }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-lg-1 d-flex gap-2 justify-content-end">
        <button class="btn btn-outline-secondary btn-filter-compact" type="submit">Applica filtri</button>
      </div>
    </form>

    {% if status_filter or category_filter or search_query %}
    <div class="d-flex align-items-center gap-2 mt-3">
      <span class="small text-muted">Filtri attivi:</span>
      {% if search_query %}<span class="filter-tag">Testo: {{ request.args.get('q') }}</span>{% endif %}
      {% if status_filter %}<span class="filter-tag">Stato: {{ status_choices[status_filter].label }}</span>{% endif %}
      {% if category_filter %}<span class="filter-tag">Categoria: {{ category_filter }}</span>{% endif %}
      <a class="btn btn-link p-0 ms-2" href="{{ url_for('results') }}">Pulisci</a>
    </div>
    {% endif %}
  </div>
</div>

  <div class="card brand-card">
    <div class="card-body">
      <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3">
      <div class="d-flex align-items-center gap-3 text-muted small">
        <span class="text-muted" id="selected-count">0 prodotti selezionati</span>
        <span class="badge rounded-pill text-bg-light border">Filtro attivo: {{ 'sì' if status_filter or category_filter or search_query else 'no' }}</span>
      </div>
      <div class="d-flex gap-2 flex-wrap justify-content-end">
        <button class="btn btn-outline-secondary" type="button" id="remove-btn" disabled>Rimuovi selezionati</button>
        <button class="btn btn-outline-secondary" type="button" id="export-btn" disabled>
          <span class="spinner-border spinner-border-sm align-text-bottom me-2 d-none" role="status" aria-hidden="true"></span>
          <span class="btn-label">Esporta risultati</span>
        </button>
        <button class="btn btn-primary" type="button" id="save-btn" disabled>
          <span class="spinner-border spinner-border-sm align-text-bottom me-2 d-none" role="status" aria-hidden="true"></span>
          <span class="btn-label">Salva tutti su PIM</span>
        </button>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table align-middle mb-0">
        <thead>
          <tr>
            <th class="text-uppercase small text-muted circle-40">
              <div class="form-check mb-0">
                <input class="form-check-input" type="checkbox" id="select-all" aria-label="Seleziona tutti i prodotti" />
              </div>
            </th>
            <th class="text-uppercase small text-muted">Codice</th>
            <th class="text-uppercase small text-muted">Categoria PIM</th>
            <th class="text-uppercase small text-muted">Categoria AI</th>
            <th class="text-uppercase small text-muted">Codice EAN</th>
            <th class="text-uppercase small text-muted">Denominazione di vendita</th>
            <th class="text-uppercase small text-muted">Prezzo</th>
            <th class="text-uppercase small text-muted">Stato</th>
            <th class="text-uppercase small text-muted text-end">Azioni</th>
          </tr>
        </thead>
        <tbody>
          {% for product in products %}
          <tr class="{% if search_query or status_filter or category_filter %}filtered-highlight{% endif %}">
            <td>
              <div class="form-check mb-0">
                <input class="form-check-input product-select" type="checkbox" value="{{ product.code }}" aria-label="Seleziona {{ product.code }}" />
              </div>
            </td>
            <td class="fw-semibold">{{ product.code }}</td>
            <td>
              {% set pim_categories = product.categories[1:] if product.categories|length > 1 else [] %}
              {% if pim_categories %}
                <ul class="mb-0 small text-muted list-unstyled">
                  {% for category in pim_categories %}
                    <li>{{ category.name }}</li>
                  {% endfor %}
                </ul>
              {% else %}
              <span class="text-muted small">Nessuna categoria disponibile</span>
              {% endif %}
            </td>
            <td>
              {% if product.ai_category %}
              {% set ai = product.ai_category %}
              {% set ai_name = ai.category_2_name or ai.category_1_name %}
              <div class="small fw-semibold">{{ ai_name or '—' }}</div>
              {% else %}
              <span class="text-muted small">Nessuna categoria AI</span>
              {% endif %}
            </td>
            <td class="text-muted small">{{ product.codice_ean or '—' }}</td>
            <td class="fw-semibold">{{ product.denominazione_vendita or '—' }}</td>
            <td class="fw-semibold">€ {{ '%.2f'|format(product.price) }}</td>
            <td>
              {% set status_key = product.status %}
              {% set status_meta = status_choices.get(status_key, {'label': status_key, 'badge': 'secondary'}) %}
              <span class="status-pill status-{{ status_key }}">
                <span class="status-dot"></span>
                {{ status_meta.label }}
              </span>
            </td>
            <td class="text-end">
              <a class="btn btn-link text-decoration-none" href="{{ url_for('product_detail', code=product.code) }}">Modifica</a>
              <button class="btn btn-outline-secondary ms-2" type="button">Invia al PIM</button>
            </td>
          </tr>
          {% else %}
            <tr>
              <td colspan="9" class="text-center text-muted py-4">Nessun prodotto corrisponde ai filtri applicati.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
<script>
  (function () {
    const selectAll = document.getElementById("select-all");
    const productCheckboxes = Array.from(document.querySelectorAll(".product-select"));
    const selectedCountEl = document.getElementById("selected-count");
    const buttonsToToggle = [
      document.getElementById("export-btn"),
      document.getElementById("save-btn"),
      document.getElementById("remove-btn"),
    ];

    const updateSelectionUi = () => {
      const selected = productCheckboxes.filter((cb) => cb.checked);
      const count = selected.length;
      if (selectedCountEl) {
        selectedCountEl.textContent = `${count} prodotto${count === 1 ? '' : 'i'} selezionato${count === 1 ? '' : 'i'}`;
      }

      buttonsToToggle.forEach((btn) => {
        if (!btn) return;
        btn.disabled = count === 0;
      });

      if (selectAll) {
        const allChecked = count === productCheckboxes.length && count > 0;
        selectAll.checked = allChecked;
        selectAll.indeterminate = count > 0 && count < productCheckboxes.length;
      }
    };

    selectAll?.addEventListener("change", (event) => {
      const { checked } = event.target;
      productCheckboxes.forEach((cb) => {
        cb.checked = checked;
      });
      updateSelectionUi();
    });

    productCheckboxes.forEach((checkbox) => {
      checkbox.addEventListener("change", updateSelectionUi);
    });

    const wireLoading = (buttonId, successLabel) => {
      const btn = document.getElementById(buttonId);
      if (!btn) return;
      const spinner = btn.querySelector(".spinner-border");
      const label = btn.querySelector(".btn-label");
      btn.addEventListener("click", () => {
        if (btn.disabled) return;
        btn.setAttribute("disabled", "disabled");
        spinner?.classList.remove("d-none");
        label.textContent = successLabel;
        setTimeout(() => {
          btn.removeAttribute("disabled");
          spinner?.classList.add("d-none");
          label.textContent = btn.id === "export-btn" ? "Esporta risultati" : "Salva tutti su PIM";
        }, 1200);
      });
    };

    const removeBtn = document.getElementById("remove-btn");
    removeBtn?.addEventListener("click", () => {
      if (removeBtn.disabled) return;
      productCheckboxes
        .filter((cb) => cb.checked)
        .forEach((cb) => {
          cb.closest("tr")?.remove();
        });

      const remaining = Array.from(document.querySelectorAll(".product-select"));
      productCheckboxes.length = 0;
      remaining.forEach((cb) => productCheckboxes.push(cb));
      updateSelectionUi();
    });

    wireLoading("export-btn", "Preparazione file...");
    wireLoading("save-btn", "Invio in corso...");
    updateSelectionUi();
  })();
</script>
{% endblock %}
