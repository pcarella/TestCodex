{% extends 'base.html' %}
{% block content %}
{% set total = products | length %}
{% set ready_count = status_counts.get('ready', 0) %}
{% set review_count = status_counts.get('review', 0) %}
{% set error_count = status_counts.get('error', 0) %}
{% set exported_count = status_counts.get('exported', 0) %}

<div class="d-flex flex-wrap gap-3 justify-content-between align-items-start mb-3">
  <div>
    <div class="section-title mb-2"><span class="text-warning">●</span> Riepilogo</div>
    <h1 class="h4 mb-1">Prodotti richiesti</h1>
    <p class="text-muted mb-0">I dati mostrati provengono dall'API OCC. Tutti i prodotti recuperati partono in stato "Richiede revisione".</p>
  </div>
  <div class="text-end">
    <div class="summary-chip mb-2">
      <span class="fw-bold">{{ total }}</span>
      <span class="text-muted">prodotti trovati</span>
    </div>
    <div class="small text-muted">
      <span id="ready-count">{{ ready_count }}</span> pronti,
      <span id="review-count">{{ review_count }}</span> da rivedere,
      <span id="error-count">{{ error_count }}</span> in errore,
      <span id="exported-count">{{ exported_count }}</span> esportati.
    </div>
  </div>
</div>

  <div class="alert alert-info shadow-soft" role="status" aria-live="polite">
    <div class="fw-semibold">Significato degli stati</div>
    <ul class="legend-list small mb-0">
      <li><span class="status-pill status-ready"><span class="status-dot"></span>Pronto</span> Contenuti completi e pronti per il PIM.</li>
      <li><span class="status-pill status-review"><span class="status-dot"></span>Richiede revisione</span> Controlla titolo o categoria prima di inviare.</li>
      <li><span class="status-pill status-error"><span class="status-dot"></span>Errore</span> Codice non riconosciuto o dati mancanti.</li>
      <li><span class="status-pill status-exported"><span class="status-dot"></span>Esportato</span> Già inviato al PIM.</li>
    </ul>
  </div>

  {% if missing_codes %}
  <div class="alert alert-warning" role="alert">
    <div class="fw-semibold">Codici non trovati (API in errore):</div>
    <p class="mb-0">{{ missing_codes | join(', ') }}</p>
  </div>
  {% endif %}

<div class="card brand-card mb-3">
  <div class="card-body">
    <form class="row gy-3 align-items-end" method="get">
      <div class="col-lg-5">
        <label class="form-label" for="q">Cerca</label>
        <input type="text" class="form-control" id="q" name="q" placeholder="Cerca per codice o nome prod" value="{{ request.args.get('q', '') }}" />
      </div>
      <div class="col-lg-3 col-md-6">
        <label class="form-label" for="status">Stato</label>
        <select class="form-select" id="status" name="status">
          <option value="">Tutti gli stati</option>
          {% for key, meta in status_choices.items() %}
          <option value="{{ key }}" {% if status_filter == key %}selected{% endif %}>{{ meta.label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-lg-3 col-md-6">
        <label class="form-label" for="category">Categoria</label>
        <select class="form-select" id="category" name="category">
          <option value="">Tutte le categorie</option>
          {% for category in categories %}
          <option value="{{ category }}" {% if category_filter == category %}selected{% endif %}>{{ category }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-lg-1 d-flex gap-2 justify-content-end">
        <button class="btn btn-outline-secondary btn-filter-compact" type="submit">Applica filtri</button>
      </div>
    </form>

    {% if status_filter or category_filter or search_query %}
    <div class="d-flex align-items-center gap-2 mt-3">
      <span class="small text-muted">Filtri attivi:</span>
      {% if search_query %}<span class="filter-tag">Testo: {{ request.args.get('q') }}</span>{% endif %}
      {% if status_filter %}<span class="filter-tag">Stato: {{ status_choices[status_filter].label }}</span>{% endif %}
      {% if category_filter %}<span class="filter-tag">Categoria: {{ category_filter }}</span>{% endif %}
      <a class="btn btn-link p-0 ms-2" href="{{ url_for('results') }}">Pulisci</a>
    </div>
    {% endif %}
  </div>
</div>

  <div class="card brand-card">
    <div class="card-body">
      <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3">
      <div class="d-flex align-items-center gap-3 text-muted small">
        <span class="text-muted" id="selected-count">0 prodotti selezionati</span>
        <span class="badge rounded-pill text-bg-light border">Filtro attivo: {{ 'sì' if status_filter or category_filter or search_query else 'no' }}</span>
      </div>
      <div class="d-flex gap-2 flex-wrap justify-content-end">
        <button class="btn btn-outline-primary" type="button" id="approve-btn" disabled>Approva selezionati</button>
        <button class="btn btn-outline-secondary" type="button" id="remove-btn" disabled>Rimuovi selezionati</button>
        <button class="btn btn-outline-secondary" type="button" id="export-btn" disabled>
          <span class="spinner-border spinner-border-sm align-text-bottom me-2 d-none" role="status" aria-hidden="true"></span>
          <span class="btn-label">Esporta risultati</span>
        </button>
        <button class="btn btn-primary" type="button" id="save-btn" disabled>
          <span class="spinner-border spinner-border-sm align-text-bottom me-2 d-none" role="status" aria-hidden="true"></span>
          <span class="btn-label">Salva tutti su PIM</span>
        </button>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table align-middle mb-0">
        <thead>
          <tr>
            <th class="text-uppercase small text-muted circle-40">
              <div class="form-check mb-0">
                <input class="form-check-input" type="checkbox" id="select-all" aria-label="Seleziona tutti i prodotti" />
              </div>
            </th>
            <th class="text-uppercase small text-muted">Codice</th>
            <th class="text-uppercase small text-muted">Categoria PIM</th>
            <th class="text-uppercase small text-muted">Categoria AI</th>
            <th class="text-uppercase small text-muted">Codice EAN</th>
            <th class="text-uppercase small text-muted">Denominazione di vendita</th>
            <th class="text-uppercase small text-muted">Prezzo</th>
            <th class="text-uppercase small text-muted">Stato</th>
            <th class="text-uppercase small text-muted text-end">Azioni</th>
          </tr>
        </thead>
        <tbody>
          {% for product in products %}
          <tr class="{% if search_query or status_filter or category_filter %}filtered-highlight{% endif %}" data-code="{{ product.code }}" data-status="{{ product.status }}">
            <td>
              <div class="form-check mb-0">
                <input class="form-check-input product-select" type="checkbox" value="{{ product.code }}" aria-label="Seleziona {{ product.code }}" data-status="{{ product.status }}" />
              </div>
            </td>
            <td class="fw-semibold">{{ product.code }}</td>
            <td>
              {% set pim_categories = product.categories[1:] if product.categories|length > 1 else [] %}
              {% if pim_categories %}
                <ul class="mb-0 small text-muted list-unstyled">
                  {% for category in pim_categories %}
                    <li>{{ category.name }}</li>
                  {% endfor %}
                </ul>
              {% else %}
              <span class="text-muted small">Nessuna categoria disponibile</span>
              {% endif %}
            </td>
            <td>
              {% if product.ai_category %}
              {% set ai = product.ai_category %}
              {% set ai_name = ai.category_2_name or ai.category_1_name %}
              <div class="small fw-semibold">{{ ai_name or '—' }}</div>
              {% else %}
              <span class="text-muted small">Nessuna categoria AI</span>
              {% endif %}
            </td>
            <td class="text-muted small">{{ product.codice_ean or '—' }}</td>
            <td class="fw-semibold">{{ product.denominazione_vendita or '—' }}</td>
            <td class="fw-semibold">€ {{ '%.2f'|format(product.price) }}</td>
            <td>
              {% set status_key = product.status %}
              {% set status_meta = status_choices.get(status_key, {'label': status_key, 'badge': 'secondary'}) %}
              <span class="status-pill status-{{ status_key }}" data-role="status-pill">
                <span class="status-dot"></span>
                <span class="status-text">{{ status_meta.label }}</span>
              </span>
            </td>
            <td class="text-end">
              <a class="btn btn-link text-decoration-none" href="{{ url_for('product_detail', code=product.code) }}">Modifica</a>
              {% if product.status != 'exported' %}
              <button class="btn btn-outline-primary ms-2 action-approve" type="button" data-code="{{ product.code }}" {% if product.status == 'ready' %}disabled{% endif %}>Approva</button>
              <button class="btn btn-outline-secondary ms-2 action-export" type="button" data-code="{{ product.code }}" {% if product.status != 'ready' %}disabled{% endif %}>Invia al PIM</button>
              {% else %}
              <span class="badge text-bg-light border">Già esportato</span>
              {% endif %}
            </td>
          </tr>
          {% else %}
            <tr>
              <td colspan="9" class="text-center text-muted py-4">Nessun prodotto corrisponde ai filtri applicati.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
<script>
  (function () {
    const selectAll = document.getElementById("select-all");
    const selectedCountEl = document.getElementById("selected-count");
    const approveBtn = document.getElementById("approve-btn");
    const removeBtn = document.getElementById("remove-btn");
    const exportBtn = document.getElementById("export-btn");
    const saveBtn = document.getElementById("save-btn");
    const statusChoices = {{ status_choices | tojson }};
    const statusCountsEls = {
      ready: document.getElementById("ready-count"),
      review: document.getElementById("review-count"),
      error: document.getElementById("error-count"),
      exported: document.getElementById("exported-count"),
    };

    const getCheckboxes = () => Array.from(document.querySelectorAll(".product-select"));
    const getSelectedCheckboxes = () => getCheckboxes().filter((cb) => cb.checked);

    const updateSummaryCounts = (counts) => {
      Object.entries(statusCountsEls).forEach(([key, el]) => {
        if (el && typeof counts?.[key] === "number") {
          el.textContent = counts[key];
        }
      });
    };

    const updateRowStatus = (code, statusKey) => {
      const row = document.querySelector(`tr[data-code="${code}"]`);
      if (!row) return;
      row.dataset.status = statusKey;
      const checkbox = row.querySelector(".product-select");
      if (checkbox) {
        checkbox.dataset.status = statusKey;
      }

      const pill = row.querySelector('[data-role="status-pill"]');
      if (pill) {
        pill.className = `status-pill status-${statusKey}`;
        const textEl = pill.querySelector('.status-text');
        if (textEl) {
          textEl.textContent = statusChoices?.[statusKey]?.label || statusKey;
        }
      }

      const approveAction = row.querySelector('.action-approve');
      const exportAction = row.querySelector('.action-export');

      if (approveAction) {
        approveAction.disabled = statusKey === "ready" || statusKey === "exported";
      }

      if (exportAction) {
        exportAction.disabled = statusKey !== "ready";
      }

      if (statusKey === "exported" && exportAction) {
        exportAction.classList.add("d-none");
      }
    };

    const updateSelectionUi = () => {
      const checkboxes = getCheckboxes();
      const selected = getSelectedCheckboxes();
      const count = selected.length;
      if (selectedCountEl) {
        selectedCountEl.textContent = `${count} prodotto${count === 1 ? '' : 'i'} selezionato${count === 1 ? '' : 'i'}`;
      }

      const anySelected = count > 0;
      if (approveBtn) approveBtn.disabled = !anySelected;
      if (removeBtn) removeBtn.disabled = !anySelected;

      const allReady = selected.length > 0 && selected.every((cb) => cb.dataset.status === "ready");
      if (exportBtn) exportBtn.disabled = !allReady;
      if (saveBtn) saveBtn.disabled = !allReady;

      if (selectAll) {
        const allChecked = count === checkboxes.length && count > 0;
        selectAll.checked = allChecked;
        selectAll.indeterminate = count > 0 && count < checkboxes.length;
      }
    };

    selectAll?.addEventListener("change", (event) => {
      const { checked } = event.target;
      getCheckboxes().forEach((cb) => {
        if (!cb.disabled) {
          cb.checked = checked;
        }
      });
      updateSelectionUi();
    });

    document.querySelectorAll(".product-select").forEach((checkbox) => {
      checkbox.addEventListener("change", updateSelectionUi);
    });

    const statusEndpoint = "{{ url_for('update_product_status') }}";

    const applyStatusChange = async (codes, statusKey) => {
      const response = await fetch(statusEndpoint, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token() }}",
        },
        body: JSON.stringify({ codes, status: statusKey }),
      });

      const payload = await response.json();
      if (!response.ok) {
        throw new Error(payload?.message || "Aggiornamento stato non riuscito.");
      }

      payload.updated_codes?.forEach((code) => updateRowStatus(code, statusKey));
      if (payload.status_counts) updateSummaryCounts(payload.status_counts);
      updateSelectionUi();

      return payload;
    };

    approveBtn?.addEventListener("click", async () => {
      const codes = getSelectedCheckboxes().map((cb) => cb.value);
      if (!codes.length) return;
      try {
        await applyStatusChange(codes, "ready");
      } catch (error) {
        alert(error.message);
      }
    });

    document.querySelectorAll('.action-approve').forEach((btn) => {
      btn.addEventListener('click', async () => {
        const code = btn.dataset.code;
        try {
          await applyStatusChange([code], "ready");
        } catch (error) {
          alert(error.message);
        }
      });
    });

    const handleExport = async (codes) => {
      if (!codes.length) return;
      try {
        const payload = await applyStatusChange(codes, "exported");
        if (payload?.skipped_codes?.length) {
          alert(`Alcuni prodotti non erano pronti e sono stati ignorati: ${payload.skipped_codes.join(', ')}`);
        }
      } catch (error) {
        alert(error.message);
      }
    };

    exportBtn?.addEventListener("click", () => handleExport(getSelectedCheckboxes().map((cb) => cb.value)));

    document.querySelectorAll('.action-export').forEach((btn) => {
      btn.addEventListener('click', () => handleExport([btn.dataset.code]));
    });

    const wireLoading = (buttonId, successLabel) => {
      const btn = document.getElementById(buttonId);
      if (!btn) return;
      const spinner = btn.querySelector(".spinner-border");
      const label = btn.querySelector(".btn-label");
      btn.addEventListener("click", () => {
        if (btn.disabled) return;
        btn.setAttribute("disabled", "disabled");
        spinner?.classList.remove("d-none");
        label.textContent = successLabel;
        setTimeout(() => {
          btn.removeAttribute("disabled");
          spinner?.classList.add("d-none");
          label.textContent = btn.id === "export-btn" ? "Esporta risultati" : "Salva tutti su PIM";
        }, 1200);
      });
    };

    removeBtn?.addEventListener("click", () => {
      if (removeBtn.disabled) return;
      getSelectedCheckboxes().forEach((cb) => {
        cb.closest("tr")?.remove();
      });
      updateSelectionUi();
    });

    wireLoading("export-btn", "Preparazione file...");
    wireLoading("save-btn", "Invio in corso...");
    updateSelectionUi();
  })();
</script>
{% endblock %}
